<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper">
    <insert id="outgoJig">
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgo_submit where outgo_submit.id = #{id}),
                (select user_id from outgo_submit where outgo_submit.id = #{id}),
                0, #{rec_id}, now(), #{code}, #{seq_id});
        insert into outgoing_jig(code, seq_id, user_id, submit_time, outgo_time)
        values (#{code}, #{seq_id}, (select user_id from outgo_submit where outgo_submit.id = #{id}),
                (select submit_time from outgo_submit where outgo_submit.id = #{id}), now());
        update jig_position
        set status = 0
        where code = #{code}
          and seq_id = #{seq_id}
    </insert>
    <insert id="addShoplist">
        insert into purchase_income_submit(submit_id, code, count, submit_time, status, production_line_id, bill_no)
        values (#{submit_id}, #{code}, #{count}, now(), 0, #{production_line_id}, #{bill_no});
    </insert>
    <update id="returnJig">
        update jig_position
        set status = 1
        where code = #{code}
          and seq_id = #{seq_id};
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgoing_jig where outgoing_jig.id = #{id}),
                (select user_id from outgoing_jig where outgoing_jig.id = #{id}),
                1, #{rec_id}, now(), #{code}, #{seq_id});
    </update>
    <update id="updatePurchaseIncomeSubmit">
        update purchase_income_submit
        set code              = #{code},
            count=#{count},
            production_line_id=#{production_line_id}
        where id = #{id}
    </update>
    <delete id="deleteOutgoSubmit">
        delete
        from outgo_submit
        where id = #{id}
    </delete>
    <delete id="deleteOutgoingJig">
        delete
        from outgoing_jig
        where id = #{id}
    </delete>
    <select id="searchJigDefinition" resultType="com.jig.entity.JigDefinition">
        select * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
        limit #{pageNumber},5
    </select>
    <select id="searchJigDefinitionPage" resultType="java.lang.Integer">
        SELECT count(*)
        FROM jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getSimpleJigDefinition" resultType="com.jig.entity.JigDefinition">
        select *
        from jig_definition_entity_view
        where `id` = #{id}
    </select>
    <select id="searchAllJigDefinition" resultType="com.jig.entity.JigDefinition">
        SELECT * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getOutgoSubmit" resultType="com.jig.entity.OutgoSubmit">
        select *
        from outgo_submit_entity_view
    </select>
    <select id="getPosition" resultType="com.jig.entity.Position">
        select jig_cabinet_id, location_id, bin, status
        from jig_position
        where code = #{code}
          and seq_id = #{seq_id}
    </select>
    <select id="getOutgoingJig" resultType="com.jig.entity.OutgoingJig">
        select *
        from outgoing_jig_entity_view
    </select>
    <select id="getProductionLineList" resultType="com.jig.entity.ProductionLine">
        select *
        from production_line;
    </select>
    <select id="getCodeList" resultType="java.lang.String">
        select code
        from jig_definition;
    </select>
    <select id="getPurchaseIncomeSubmitList" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select purchase_income_submit.*, production_line.name production_line_name, user.name submit_name
        from purchase_income_submit,
             user,
             production_line
        where user.id = purchase_income_submit.submit_id
          and purchase_income_submit.production_line_id = production_line.id
    </select>
</mapper>
