<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper">
    <insert id="naiveOutgoJig">
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgo_submit where outgo_submit.id = #{id}),
                (select user_id from outgo_submit where outgo_submit.id = #{id}),
                0, #{rec_id}, now(), #{code}, #{seq_id});
        insert into outgoing_jig(code, seq_id, user_id, submit_time, outgo_time)
        values (#{code}, #{seq_id}, (select user_id from outgo_submit where outgo_submit.id = #{id}),
                (select submit_time from outgo_submit where outgo_submit.id = #{id}), now());
        update jig_position
        set status = 0
        where code = #{code}
          and seq_id = #{seq_id}
    </insert>
    <insert id="highAddShoplist">
        insert into purchase_income_submit(submit_id, code, count, submit_time, status, production_line_id, bill_no)
        values (#{submit_id}, #{code}, #{count}, now(), 0, #{production_line_id}, #{bill_no})
    </insert>
    <update id="naiveReturnJig">
        update jig_position
        set status = 1
        where code = #{code}
          and seq_id = #{seq_id};
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgoing_jig where outgoing_jig.id = #{id}),
                (select user_id from outgoing_jig where outgoing_jig.id = #{id}),
                1, #{rec_id}, now(), #{code}, #{seq_id})
    </update>
    <update id="highUpdatePurchaseIncomeSubmit">
        update purchase_income_submit
        set code              = #{code},
            count=#{count},
            production_line_id=#{production_line_id}
        where id = #{id}
    </update>
    <delete id="naiveDeleteOutgoSubmit">
        delete
        from outgo_submit
        where id = #{id}
    </delete>
    <delete id="naiveDeleteOutgoingJig">
        delete
        from outgoing_jig
        where id = #{id}
    </delete>
    <select id="naiveSearchJigDefinition" resultType="com.jig.entity.JigDefinition">
        select * from jig_definition_entity_view
        <where>
            <if test="code != null and code != ''">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null and workcell != ''">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null and family != ''">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null and userFor != ''">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
        limit #{pageNumber},5
    </select>
    <select id="naiveSearchJigDefinitionPage" resultType="java.lang.Integer">
        SELECT count(*)
        FROM jig_definition_entity_view
        <where>
            <if test="code != null and code != ''">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null and workcell != ''">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null and family != ''">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null and userFor != ''">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getSimpleJigDefinition" resultType="com.jig.entity.JigDefinition">
        select *
        from jig_definition_entity_view
        where `id` = #{id}
    </select>
    <select id="searchAllJigDefinition" resultType="com.jig.entity.JigDefinition">
        SELECT * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="naiveGetOutgoingSubmit" resultType="com.jig.entity.OutgoSubmit">
        select *
        from outgo_submit_entity_view
        limit #{page_number},5
    </select>
    <select id="naiveGetOutgoSubmitPage" resultType="java.lang.Integer">
        select count(*)
        from outgo_submit_entity_view
    </select>
    <select id="getPosition" resultType="com.jig.entity.Position">
        select jig_cabinet_id, location_id, bin, status
        from jig_position
        where code = #{code}
          and seq_id = #{seq_id}
    </select>
    <select id="naiveGetOutgoingJig" resultType="com.jig.entity.OutgoingJig">
        select *
        from outgoing_jig_entity_view
        limit #{page_number},5
    </select>
    <select id="getOutgoingJigPage" resultType="java.lang.Integer">
        select count(*)
        from outgoing_jig_entity_view
    </select>
    <select id="getProductionLineList" resultType="com.jig.entity.ProductionLine">
        select *
        from production_line
    </select>
    <select id="getCodeList" resultType="java.lang.String">
        select code
        from jig_definition
    </select>
    <select id="highGetPurchaseIncomeSubmitList" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select ps.*,
               production_line.name production_line_name,
               u1.name              submit_name,
               u2.name              first_acceptor_name,
               u3.name              final_acceptor_name
        from purchase_income_submit ps
                 left join user u1 on ps.submit_id = u1.id
                 left join user u2 on
            ps.first_acceptor = u2.id
                 left join `user` u3 on ps.final_acceptor = u3.id,
             production_line
        where ps.production_line_id = production_line.id
        limit #{page_number},5
    </select>
    <select id="highGetPurchaseIncomeSubmitListPage" resultType="java.lang.Integer">
        select count(*)
        from purchase_income_submit ps
                 left join user u1 on ps.submit_id = u1.id
                 left join user u2 on
            ps.first_acceptor = u2.id
                 left join `user` u3 on ps.final_acceptor = u3.id,
             production_line
        where ps.production_line_id = production_line.id
    </select>
    <select id="highSearchPurchaseIncomeHistory" resultType="com.jig.entity.PurchaseIncomeHistory">
        select ph.*, production_line.name production_line_name, u1.name submit_name,u2.name first_acceptor_name,u3.name
        final_acceptor_name
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
        limit #{page_number},5
    </select>
    <select id="highSearchPurchaseIncomeHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highSearchAllPurchaseIncomeHistory" resultType="com.jig.entity.PurchaseIncomeHistory">
        select ph.*, production_line.name production_line_name, u1.name submit_name,u2.name first_acceptor_name,u3.name
        final_acceptor_name
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <delete id="highDeletePurchaseSubmit">
        delete
        from purchase_income_submit
        where id = #{id}
    </delete>
    <select id="highGetRepairJig" resultType="com.jig.entity.RepairJig">
        select rs.*, u1.name submit_name, u2.name acceptor_name
        from repair_submit rs
                 left join `user` u1 on rs.submit_id = u1.id
                 left join `user` u2 on rs.acceptor_id = u2.id
        limit #{page_number},5
    </select>
    <select id="highGetRepairJigPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit rs
                 left join `user` u1 on rs.submit_id = u1.id
                 left join `user` u2 on rs.acceptor_id = u2.id
    </select>
    <select id="highSearchRepairHistory" resultType="com.jig.entity.RepairJig">
        select rh.*,u1.name submit_name,u2.name acceptor_name
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        <where>
            <if test="code != null and code != ''">
                and rh.code like concat('%',#{code},'%')
            </if>
            <if test="seq_id != null and seq_id !=''">
                and rh.seq_id = #{seq_id}
            </if>
            <if test="submit_name != null and submit_name != ''">
                and u1.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status != null and status != ''">
                and rh.status = #{status}
            </if>
            <if test="start_date != end_date">
                and rh.submit_time between #{start_date} and #{end_date}
            </if>
        </where>
        limit #{page_number},5
    </select>
    <select id="highSearchAllRepairHistory" resultType="com.jig.entity.RepairJig">
        select rh.*,u1.name submit_name,u2.name acceptor_name
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        <where>
            <if test="code != null and code != ''">
                and rh.code like concat('%',#{code},'%')
            </if>
            <if test="seq_id != null and seq_id !=''">
                and rh.seq_id = #{seq_id}
            </if>
            <if test="submit_name != null and submit_name != ''">
                and u1.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status != null and status != ''">
                and rh.status = #{status}
            </if>
            <if test="start_date != end_date">
                and rh.submit_time between #{start_date} and #{end_date}
            </if>
        </where>
    </select>
    <select id="highSearchRepairHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        <where>
            <if test="code != null and code != ''">
                and rh.code like concat('%',#{code},'%')
            </if>
            <if test="seq_id != null and seq_id !=''">
                and rh.seq_id = #{seq_id}
            </if>
            <if test="submit_name != null and submit_name != ''">
                and u1.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status != null and status != ''">
                and rh.status = #{status}
            </if>
            <if test="start_date != end_date">
                and rh.submit_time between #{start_date} and #{end_date}
            </if>
        </where>
    </select>
    <select id="highGetScrap" resultType="com.jig.entity.ScrapSubmit">
        select ss.*, u1.name submit_name, u2.name first_acceptor_name
        from scrap_submit ss
                 left join `user` u1 on ss.submit_id = u1.id
                 left join `user` u2 on ss.first_acceptor = u2.id
                 left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        limit #{page_number},5
    </select>
    <select id="highGetScrapPage" resultType="java.lang.Integer">
        select count(*)
        from scrap_submit ss
                 left join `user` u1 on ss.submit_id = u1.id
                 left join `user` u2 on ss.first_acceptor = u2.id
                 left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
    </select>
    <select id="highSearchScrapHistory" resultType="com.jig.entity.ScrapHistory">
        select ss.*,u1.name submit_name,u2.name first_acceptor_name
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
        limit #{page_number},5
    </select>
    <select id="highSearchScrapHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highSearchAllScrapHistory" resultType="com.jig.entity.ScrapHistory">
        select ss.*,u1.name submit_name,u2.name first_acceptor_name
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
</mapper>
