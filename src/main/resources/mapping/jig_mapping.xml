<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper">
    <insert id="naiveOutgoJig">
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgo_submit where outgo_submit.id = #{id}),
                (select user_id from outgo_submit where outgo_submit.id = #{id}),
                0, #{rec_id}, now(), #{code}, #{seq_id});
        insert into outgoing_jig(code, seq_id, user_id, submit_time, outgo_time)
        values (#{code}, #{seq_id}, (select user_id from outgo_submit where outgo_submit.id = #{id}),
                (select submit_time from outgo_submit where outgo_submit.id = #{id}), now());
        update jig_position
        set status = 0
        where code = #{code}
          and seq_id = #{seq_id}
    </insert>
    <insert id="highAddShoplist">
        insert into purchase_income_submit(submit_id, code, count, submit_time, status, production_line_id, bill_no)
        values (#{submit_id}, #{code}, #{count}, now(), 0, #{production_line_id}, #{bill_no})
    </insert>
    <insert id="highSubmitScrap">
        update jig_position
        set status = 3
        where seq_id = #{seq_id}
          and code = #{code};
        insert into scrap_submit(code, seq_id, submit_time, submit_id, used_count, scrap_reason, scrap_photo_url,
                                 status)
            value (#{code}, #{seq_id}, now(), #{submit_id},
                   (select used_count from jig_entity where code = #{code} and seq_id = #{seq_id}), #{scrap_reason},
                   #{pathName}, 0);
        insert into message(id, generate_id, generate_time, accept_type, status, message, tab_id)
        values (UUID(), #{submit_id}, now(), 'supervisor', '00', '提交了新的报废申请', 'scrap_submit');
    </insert>
    <update id="naiveReturnJig">
        update jig_position
        set status = 1
        where code = #{code}
          and seq_id = #{seq_id};
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgoing_jig where outgoing_jig.id = #{id}),
                (select user_id from outgoing_jig where outgoing_jig.id = #{id}),
                1, #{rec_id}, now(), #{code}, #{seq_id})
    </update>
    <update id="highUpdatePurchaseIncomeSubmit">
        update purchase_income_submit
        set code              = #{code},
            count=#{count},
            production_line_id=#{production_line_id}
        where id = #{id}
    </update>
    <insert id="highAgreeRepairSubmit">
        update repair_submit
        set acceptor_id   = #{submit_id},
            acceptor_time = now(),
            status        = 1
        where id = #{id};
        insert into repair_submit_history
        select *
        from repair_submit
        where id = #{id};
        delete
        from repair_submit
        where id = #{id};
        insert into message(id, generate_id, generate_time, accept_type, status, message)
        values (UUID(), #{submit_id}, now(), 'naive', '00', '同意了你的报修申请');
    </insert>
    <insert id="highDisagreeRepairSubmit">
        update repair_submit
        set acceptor_id     = #{submit_id},
            acceptor_time   = now(),
            status          = 2,
            acceptor_reason = #{reason}
        where id = #{id};
        update jig_position
        set status = 1
        where id = #{id};
        insert into repair_submit_history
        select *
        from repair_submit
        where id = #{id};
        delete
        from repair_submit
        where id = #{id};
        insert into message(id, generate_id, generate_time, accept_type, status, message)
        values (UUID(), #{submit_id}, now(), 'naive', '00', ' 拒绝了你的报修申请');
    </insert>
    <delete id="naiveDeleteOutgoSubmit">
        delete
        from outgo_submit
        where id = #{id}
    </delete>
    <delete id="naiveDeleteOutgoingJig">
        delete
        from outgoing_jig
        where id = #{id}
    </delete>
    <select id="naiveSearchJigDefinition" resultType="com.jig.entity.JigDefinition">
        select * from jig_definition_entity_view
        <where>
            <if test="code != null and code != ''">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null and workcell != ''">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null and family != ''">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null and userFor != ''">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
        limit #{pageNumber},#{page_size}
    </select>
    <select id="naiveSearchJigDefinitionPage" resultType="java.lang.Integer">
        SELECT count(*)
        FROM jig_definition_entity_view
        <where>
            <if test="code != null and code != ''">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null and workcell != ''">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null and family != ''">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null and userFor != ''">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getSimpleJigDefinition" resultType="com.jig.entity.JigDefinition">
        select *
        from jig_definition_entity_view
        where `id` = #{id}
    </select>
    <select id="searchAllJigDefinition" resultType="com.jig.entity.JigDefinition">
        SELECT * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="naiveGetOutgoingSubmit" resultType="com.jig.entity.OutgoSubmit">
        select *
        from outgo_submit_entity_view
        limit #{page_number},5
    </select>
    <select id="naiveGetOutgoSubmitPage" resultType="java.lang.Integer">
        select count(*)
        from outgo_submit_entity_view
    </select>
    <select id="getPosition" resultType="com.jig.entity.Position">
        select jig_cabinet_id, location_id, bin, status
        from jig_position
        where code = #{code}
          and seq_id = #{seq_id}
    </select>
    <select id="naiveGetOutgoingJig" resultType="com.jig.entity.OutgoingJig">
        select *
        from outgoing_jig_entity_view
        limit #{page_number},5
    </select>
    <select id="getOutgoingJigPage" resultType="java.lang.Integer">
        select count(*)
        from outgoing_jig_entity_view
    </select>
    <select id="getProductionLineList" resultType="com.jig.entity.ProductionLine">
        select *
        from production_line
    </select>
    <select id="getCodeList" resultType="java.lang.String">
        select code
        from jig_definition
    </select>
    <select id="highGetPurchaseIncomeSubmitList" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select ps.*,
               production_line.name production_line_name,
               u1.name              submit_name,
               u2.name              first_acceptor_name,
               u3.name              final_acceptor_name
        from purchase_income_submit ps
                 left join user u1 on ps.submit_id = u1.id
                 left join user u2 on
            ps.first_acceptor = u2.id
                 left join `user` u3 on ps.final_acceptor = u3.id,
             production_line
        where ps.production_line_id = production_line.id
        limit #{page_number},5
    </select>
    <select id="highGetPurchaseIncomeSubmitListPage" resultType="java.lang.Integer">
        select count(*)
        from purchase_income_submit ps
                 left join user u1 on ps.submit_id = u1.id
                 left join user u2 on
            ps.first_acceptor = u2.id
                 left join `user` u3 on ps.final_acceptor = u3.id,
             production_line
        where ps.production_line_id = production_line.id
    </select>
    <select id="highSearchPurchaseIncomeHistory" resultType="com.jig.entity.PurchaseIncomeHistory">
        select ph.*, production_line.name production_line_name, u1.name submit_name,u2.name first_acceptor_name,u3.name
        final_acceptor_name
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
        limit #{page_number},#{page_size}
    </select>
    <select id="highSearchPurchaseIncomeHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highSearchAllPurchaseIncomeHistory" resultType="com.jig.entity.PurchaseIncomeHistory">
        select ph.*, production_line.name production_line_name, u1.name submit_name,u2.name first_acceptor_name,u3.name
        final_acceptor_name
        from purchase_income_submit_history ph left join user u1 on ph.submit_id = u1.id left join user u2 on
        ph.first_acceptor = u2.id left join `user` u3 on ph.final_acceptor = u3.id,production_line
        WHERE ph.production_line_id = production_line.id
        <if test="bill_no != null and bill_no != ''">
            and ph.bill_no like concat('%',#{bill_no},'%')
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="code != null and code != ''">
            and ph.code like concat('%',#{code},'%')
        </if>
        <if test="production_line_id != null and production_line_id != ''">
            and ph.production_line_id = #{production_line_id}
        </if>
        <if test="status != null and status != ''">
            and ph.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ph.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <delete id="highDeletePurchaseSubmit">
        delete
        from purchase_income_submit
        where id = #{id}
    </delete>
    <select id="highGetRepairJig" resultType="com.jig.entity.RepairJig">
        select rs.*, u1.name submit_name, u2.name acceptor_name
        from repair_submit rs
                 left join `user` u1 on rs.submit_id = u1.id
                 left join `user` u2 on rs.acceptor_id = u2.id
        where u1.workcell_id in (select user.workcell_id from user where id = #{id})
          and rs.status = 0
        limit #{page_number},#{page_size}
    </select>
    <select id="highGetRepairJigPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit rs
                 left join `user` u1 on rs.submit_id = u1.id
                 left join `user` u2 on rs.acceptor_id = u2.id
        where u1.workcell_id in (select user.workcell_id from user where id = #{id})
          and rs.status = 0
    </select>
    <select id="highSearchRepairHistory" resultType="com.jig.entity.RepairJigHistory">
        select rh.*,u1.name submit_name,u2.name acceptor_name
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        where u1.workcell_id in (select user.workcell_id from user where id = #{id})
        <if test="code != null and code != ''">
            and rh.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and rh.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and rh.status = #{status}
        </if>
        <if test="start_date != end_date">
            and rh.submit_time between #{start_date} and #{end_date}
        </if>
        limit #{page_number},5
    </select>
    <select id="highSearchAllRepairHistory" resultType="com.jig.entity.RepairJigHistory">
        select rh.*,u1.name submit_name,u2.name acceptor_name
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        where u1.workcell_id in (select user.workcell_id from user where id = #{id})
        <if test="code != null and code != ''">
            and rh.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and rh.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and rh.status = #{status}
        </if>
        <if test="start_date != end_date">
            and rh.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highSearchRepairHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit_history rh
        left join user u1 on rh.submit_id = u1.id
        left join user u2 on rh.acceptor_id = u2.id
        where u1.workcell_id in (select user.workcell_id from user where id = #{id})
        <if test="code != null and code != ''">
            and rh.code like concat('%',#{code},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and rh.seq_id = #{seq_id}
        </if>
        <if test="submit_name != null and submit_name != ''">
            and u1.name like concat('%',#{submit_name},'%')
        </if>
        <if test="status != null and status != ''">
            and rh.status = #{status}
        </if>
        <if test="start_date != end_date">
            and rh.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highGetScrap" resultType="com.jig.entity.ScrapSubmit">
        select ss.*, u1.name submit_name, u2.name first_acceptor_name
        from scrap_submit ss
                 left join `user` u1 on ss.submit_id = u1.id
                 left join `user` u2 on ss.first_acceptor = u2.id
                 left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        limit #{page_number},#{page_size}
    </select>
    <select id="highGetScrapPage" resultType="java.lang.Integer">
        select count(*)
        from scrap_submit ss
                 left join `user` u1 on ss.submit_id = u1.id
                 left join `user` u2 on ss.first_acceptor = u2.id
                 left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
    </select>
    <select id="highSearchScrapHistory" resultType="com.jig.entity.ScrapHistory">
        select ss.*,u1.name submit_name,u2.name first_acceptor_name
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="scrap_reason != null and scrap_reason != ''">
            and ss.scrap_reason like concat('%',#{scrap_reason},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
        limit #{page_number},5
    </select>
    <select id="highSearchScrapHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="scrap_reason != null and scrap_reason != ''">
            and ss.scrap_reason like concat('%',#{scrap_reason},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="highSearchAllScrapHistory" resultType="com.jig.entity.ScrapHistory">
        select ss.*,u1.name submit_name,u2.name first_acceptor_name
        from scrap_submit_history ss
        left join `user` u1 on ss.submit_id = u1.id
        left join `user` u2 on ss.first_acceptor = u2.id
        left join `user` u3 on ss.final_acceptor = u3.id
        where ss.submit_id = #{submit_id}
        <if test="code != null and code != ''">
            and ss.code like concat('%',#{code},'%')
        </if>
        <if test="scrap_reason != null and scrap_reason != ''">
            and ss.scrap_reason like concat('%',#{scrap_reason},'%')
        </if>
        <if test="seq_id != null and seq_id !=''">
            and ss.seq_id = #{seq_id}
        </if>
        <if test="status != null and status != ''">
            and ss.status = #{status}
        </if>
        <if test="start_date != end_date">
            and ss.submit_time between #{start_date} and #{end_date}
        </if>
    </select>
    <select id="codeGetSeqId" resultType="java.lang.String">
        select seq_id
        from jig_entity
        where code = #{code}
    </select>
    <delete id="highDeleteScrap">
        delete
        from scrap_submit
        where id = #{id}
    </delete>
    <select id="naiveGetRepairList" resultType="com.jig.entity.RepairJig">
        select rs.*, u1.name submit_name, u2.name accrptor_name
        from repair_submit rs
                 left join user u1 on rs.submit_id = u1.id
                 left join user u2 on acceptor_id = u2.id
        where submit_id = #{submit_id}
        limit #{page_number},5
    </select>
    <select id="naiveGetRepairListPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit
        where submit_id = #{submit_id};
    </select>
    <insert id="naiveSubmitRepair">
        update jig_position
        set status= 2
        where code = #{code}
          and seq_id = #{seq_id};
        insert into repair_submit(code, seq_id, repair_reason, repair_photo_url, submit_time,
                                  submit_id, status)
        values (#{code}, #{seq_id}, #{repair_reason}, #{pathName}, now(),
                #{submit_id}, 0);

    </insert>
    <select id="naiveGetRepairHistory" resultType="com.jig.entity.RepairJigHistory">
        select rs.*, u1.name submit_name, u2.name accrptor_name
        from repair_submit_history rs
                 left join user u1 on rs.submit_id = u1.id
                 left join user u2 on acceptor_id = u2.id
        where submit_id = #{submit_id}
        limit #{page_number},5
    </select>
    <select id="naiveGetRepairHistoryPage" resultType="java.lang.Integer">
        select count(*)
        from repair_submit_history
        where submit_id = #{submit_id};
    </select>
    <select id="highGetRepairCount" resultType="java.lang.Integer">
        select count(*)
        from repair_submit
                 inner join user on submit_id = user.id
        where workcell_id = (select workcell_id from user where id = #{submit_id})
    </select>
    <select id="highGetRepairBasic" resultType="java.util.Map">
        select code as name, count(0) as `value`
        from repair_submit
                 inner join user on submit_id = user.id
        where workcell_id = (select workcell_id from user where id = #{submit_id})
        group by code
    </select>
    <select id="codeGetInSeqId" resultType="java.lang.String">
        select seq_id
        from jig_position
        where code = #{code}
          and status = 1
    </select>
</mapper>
