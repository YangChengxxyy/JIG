<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper">
    <insert id="outgoingJig">
        insert into outgo_income_history(submit_time, user_id, status, rec_id, rec_time, code, seq_id)
        values ((select submit_time from outgo_submit where outgo_submit.id = #{id}),
                (select user_id from outgo_submit where outgo_submit.id = #{id}),
                0, #{rec_id}, now(), #{code}, #{seq_id});
        insert into outgoing_jig(code, seq_id, user_id, submit_time, outgo_time)
        values (#{code}, #{seq_id}, (select user_id from outgo_submit where outgo_submit.id = #{id}),
                (select submit_time from outgo_submit where outgo_submit.id = #{id}), now());
        update jig_position
        set status = 0
        where code = #{code}
          and seq_id = #{seq_id}
    </insert>
    <delete id="deleteOutgoSubmit">
        delete
        from outgo_submit
        where id = #{id}
    </delete>
    <select id="searchJigDefinition" resultType="com.jig.entity.JigDefinition">
        select * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
        limit #{pageNumber},5
    </select>
    <select id="searchJigDefinitionPage" resultType="java.lang.Integer">
        SELECT count(*)
        FROM jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getSimpleJigDefinition" resultType="com.jig.entity.JigDefinition">
        select *
        from jig_definition_entity_view
        where `id` = #{id}
    </select>
    <select id="searchAllJigDefinition" resultType="com.jig.entity.JigDefinition">
        SELECT * from jig_definition_entity_view
        <where>
            <if test="code != null">
                and code like concat('%',#{code},'%')
            </if>
            <if test="name != null">
                and name like concat('%',#{name},'%')
            </if>
            <if test="workcell != null">
                and workcell like concat('%',#{workcell},'%')
            </if>
            <if test="family != null">
                and family like concat('%',#{family},'%')
            </if>
            <if test="userFor != null">
                and user_for like concat('%',#{userFor},'%')
            </if>
        </where>
    </select>
    <select id="getOutgoingSubmit" resultType="com.jig.entity.OutgoSubmit">
        SELECT outgo_submit.*,
               jig_definition.`name`,
               `user`.`name`        user_name,
               jig_definition.user_for,
               sum(jig_stock.count) count
        FROM jig_definition,
             outgo_submit,
             `user`,
             jig_stock
        WHERE jig_definition.`code` = outgo_submit.`code`
          AND `user`.id = outgo_submit.user_id
          AND jig_stock.`code` = outgo_submit.`code`
        GROUP BY outgo_submit.`code`
    </select>
    <select id="getPosition" resultType="com.jig.entity.Position">
        select jig_cabinet_id, location_id, bin, status
        from jig_position
        where code = #{code}
          and seq_id = #{seq_id}
    </select>
</mapper>
