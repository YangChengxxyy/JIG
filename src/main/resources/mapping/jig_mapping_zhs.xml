<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper_zhs">
    <select id="get_workcell_list" resultType="com.jig.entity.Workcell">
        select * from workcell
    </select>
    <select id="get_family_list" resultType="com.jig.entity.Family">
        select * from jig_family
    </select>
    <select id="get_model_list" resultType="com.jig.entity.Model">
        select model from jig_definition group by model
    </select>
    <select id="get_part_no_list" resultType="com.jig.entity.PartNo">
        select * from jig_part_no
    </select>
    <insert id="addShoplist">
        insert into purchase_income_submit(submit_id,code,count,submit_time,status,production_line_id,bill_no)
        values (#{submit_id},#{code},#{count},#{submit_time},0,
        (select id from production_line where name = #{production_line_id}),
        #{bill_no})
    </insert>
    <select id="get_manager_purchase_submit_list" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,
        u.name submit_name,
        pl.name production_line_name,
        u1.name 'first_acceptor_name',
        u2.name 'final_acceptor_name'
        from purchase_income_submit p inner join user u on p.submit_id = u.id
                                      inner join production_line pl on p.production_line_id = pl.id
                                      left join user u1 on p.first_acceptor = u1.id
                                      left join user u2 on p.final_acceptor = u2.id
        where p.status = 2 and u.workcell_id = #{workcell_id}
        limit #{page_number},5
    </select>
    <select id="get_manager_purchase_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit p inner join user u on p.submit_id = u.id
        where status = 2 and u.workcell_id = #{workcell_id}
    </select>
    <select id="get_manager_purchase_detail" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,u.name submit_name from purchase_income_submit p inner join user u on p.submit_id = u.id
        where p.id = #{id}
    </select>
    <update id="manager_check_purchase_submit">
        update purchase_income_submit
        set final_time = now(),status = #{pass},final_acceptor = #{user_id}
        where id = #{id};

        insert into purchase_income_submit_history select * from purchase_income_submit where id = #{id};

        delete from purchase_income_submit where id = #{id}
    </update>
    <update id="manager_dont_pass_purchase_submit">
        update purchase_income_submit
        set final_time = now(),status = #{status},final_acceptor=#{user_id},final_reason=#{final_reason}
        where id = #{id};

        insert into purchase_income_submit_history select * from purchase_income_submit where id = #{id};

        delete from purchase_income_submit where id = #{id}
    </update>
    <select id="get_manager_jig_info_list" resultType="com.jig.entity.JigDefinition">
        select *  from jig_definition j inner join jig_family f on j.family_id = f.id
        limit #{page_number},5
    </select>
    <select id="get_manager_jig_info_list_pages" resultType="java.lang.Integer">
        SELECT count(*) from jig_definition
    </select>
    <select id="get_manager_purchase_submit_list_history" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,
               production_line.name production_line_name,
               u.name submit_name,
               u1.name first_acceptor_name,
               u2.name final_acceptor_name

        from purchase_income_submit_history p left join user u on p.submit_id = u.id
                                              left join user u1 on p.first_acceptor = u1.id
                                              left join user u2 on p.final_acceptor = u2.id,
            production_line
        <where>
            production_line.id = p.production_line_id and u.workcell_id = #{workcell_id}
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        <if test="page_number!='-1'.toString()">
            limit #{page_number},5
        </if>

    </select>
    <select id="get_manager_purchase_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit_history p inner join user u on p.submit_id = u.id
        <where>
            u.workcell_id = #{workcell_id}
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
    </select>
    <select id="manager_get_purchase_submit_history_operate" resultType="com.jig.entity.Operate">
        select o.*,
        u.name 'operate_man_name',
        u.type 'operate_man_type'
        from operate o inner join user u on o.operate_man_id = u.id
        where u.workcell_id = #{workcell_id}  and o.operate_key_id = #{submit_id}
        order by o.operate_time
    </select>
    <select id="get_manager_purchase_submit_count" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit
        where status = 2
    </select>
    <select id="get_manager_scrap_submit_count" resultType="java.lang.Integer">
        select count(*) from scrap_submit
    </select>
    <select id="get_manager_scrap_submit_list" resultType="com.jig.entity.ScrapSubmit">
        select s.*,
        u1.name submit_name,
        u2.name first_acceptor_name,
        u3.name final_acceptor_name
        from scrap_submit s INNER JOIN user u1 on u1.id = s.submit_id
                            LEFT JOIN user u2 on u2.id = s.first_acceptor
                            LEFT JOIN user u3 on u3.id = s.final_acceptor
        where s.status = 2 and u1.workcell_id = #{workcell_id}
    </select>
    <select id="get_manager_scrap_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from scrap_submit s INNER JOIN user u1 on u1.id = s.submit_id
        where s.status = 2 and u1.workcell_id = #{workcell_id}
    </select>
    <update id="check_manager_scrap_submit">
        update scrap_submit
        set status = #{status},final_time = now(),final_acceptor = #{user_id}
        where id = #{submit_id};

        insert into scrap_submit_history select * from scrap_submit where id = #{submit_id};

        delete from scrap_submit where id = #{submit_id}


    </update>
    <update id="manager_no_pass_submit">
        update scrap_submit
        set status = 3,final_time = now(),final_acceptor = #{user_id},final_reason = #{no_pass_reason}
        where id = #{submit_id};

        insert into scrap_submit_history select * from scrap_submit where id = #{submit_id};

        delete from scrap_submit where id = #{submit_id}


    </update>
    <select id="get_manager_scrap_submit_list_history" resultType="com.jig.entity.ScrapSubmit">
        select s.*,
        u1.name submit_name,
        u2.name first_acceptor_name,
        u3.name final_acceptor_name
        from scrap_submit_history s INNER JOIN user u1 on u1.id = s.submit_id
                                    LEFT JOIN user u2 on u2.id = s.first_acceptor
                                    LEFT JOIN user u3 on u3.id = s.final_acceptor
        <where>
            u1.workcell_id = #{workcell_id}
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        limit #{page_number},5
    </select>
    <select id="get_manager_scrap_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*) from scrap_submit_history s
        INNER JOIN user u1 on u1.id = s.submit_id
        LEFT JOIN user u2 on u2.id = s.first_acceptor
        <where>
            u1.workcell_id = #{workcell_id}
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
    </select>
    <select id="get_manager_store_jig_list" resultType="com.jig.entity.JigEntity">
        select *,count(code) as 'count' from jig_position group by code
    </select>
    <select id="get_manager_purchase_total_submit_man" resultType="com.jig.entity.PurchaseTotalSubmitManDetail">
        select p.submit_id,u.name 'submit_name',count(u.name) as 'submit_count'
        from purchase_income_submit_history p inner join user u on u.id = p.submit_id
        <where>
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and p.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        group by u.name
    </select>

    <select id="get_supervisor_jig_family" resultType="com.jig.entity.Family">
        select * from jig_family
    </select>
    <select id="get_supervisor_all_jig_info_list" resultType="com.jig.entity.JigDefinition">
        select *,u1.name 'owner_name',u2.name 'rec_by_name',u3.name 'edit_by_name'
        from jig_definition jd inner join jig_family jf on jd.family_id = jf.id
                               inner join workcell w on jd.workcell_id = w.id
                               left join user u1 on jd.owner= u1.id
                               left join user u2 on jd.rec_by = u2.id
                               left join user u3 on jd.edit_by = u3.id
    </select>
    <insert id="add_supervisor_jig_family" parameterType="com.jig.entity.Family">
        insert into jig_family (family) values (#{family});
    </insert>
    <select id="supervisor_get_delete_jig_family_count" resultType="java.lang.Integer">
        select count(family_id) from jig_definition where family_id = #{jig_family_id}
    </select>
    <delete id="supervisor_delete_jig_family">
        delete from jig_family where id = #{id}
    </delete>
    <select id="supervisor_select_jig_info" resultType="com.jig.entity.JigDefinition">
        select *,u1.name 'owner_name',u2.name 'rec_by_name',u3.name 'edit_by_name'
        from jig_definition jd left join jig_family jf on jd.family_id = jf.id
                               left join workcell w on jd.workcell_id = w.id
                               left join user u1 on jd.owner= u1.id
                               left join user u2 on jd.rec_by = u2.id
                               left join user u3 on jd.edit_by = u3.id
        <where>
            <if test="jig_code!=''">
                and jd.code like concat('%',#{jig_code},'%')
            </if>
            <if test="jig_name!=''">
                and jd.name like concat('%',#{jig_name},'%')
            </if>
            <if test="jig_model!=''">
                and jd.model = #{jig_model}
            </if>
            <if test="jig_workcell!=''">
                and w.workcell like concat('%',#{jig_workcell},'%')
            </if>
        </where>
    </select>
    <update id="supervisor_edit_jig_info" parameterType="com.jig.entity.JigDefinition">
        update jig_definition
        <set>
            name = #{jig_info.name}, code = #{jig_info.code}, model = #{jig_info.model},
            <if test="jig_info.part_no != null and jig_info.part_no != 'undefined'">
                part_no = #{jig_info.part_no},
            </if>
            family_id = #{jig_info.family_id}, workcell_id = #{jig_info.workcell_id}, upl = #{jig_info.upl},
            user_for = #{jig_info.user_for}, pm_period = #{jig_info.pm_period}, edit_time = now(),edit_by = #{user_id}
        </set>
        where id = #{jig_info.id}
    </update>
    <select id="supervisor_get_purchase_submit_list" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,u.name 'submit_name',
               pl.name 'production_line_name',
               u1.name 'first_acceptor_name',
               u2.name 'final_acceptor_name'
        from purchase_income_submit p inner join user u on p.submit_id = u.id
                                      inner join production_line pl on p.production_line_id = pl.id
                                      left join user u1 on p.first_acceptor = u1.id
                                      left join user u2 on p.final_acceptor = u2.id
        where p.status = 0 or p.status = 1 or p.status = 2
        limit #{page_number},5
    </select>
    <select id="supervisor_get_purchase_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit
        where status = 0 or status = 1 or status = 2
    </select>
    <update id="supervisor_pass_purchase_submit">
        update purchase_income_submit
        set status = #{status},first_time = now(),first_acceptor = #{first_acceptor},first_reason = null
        where id = #{id}
    </update>
    <update id="supervisor_no_pass_purchase_submit">
        update purchase_income_submit
        set status = #{status},first_time = now(),first_reason = #{first_reason},first_acceptor = #{first_acceptor}
        where id = #{id}
    </update>
    <select id="supervisor_get_purchase_submit_list_history" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,u.name 'submit_name',
               pl.name 'production_line_name',
               u1.name 'first_acceptor_name',
               u2.name 'final_acceptor'
        from purchase_income_submit_history p inner join user u on p.submit_id = u.id
                                      inner join production_line pl on p.production_line_id = pl.id
                                      left join user u1 on p.first_acceptor = u1.id
                                      left join user u2 on p.final_acceptor = u2.id
        <where>
            first_acceptor = #{user_id}
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
        </where>
        limit #{page_number},5
    </select>
    <select id="supervisor_get_purchase_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*)
        from purchase_income_submit_history
        <where>
            first_acceptor = #{user_id}
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
        </where>
    </select>
    <select id="supervisor_get_scrap_submit_list" resultType="com.jig.entity.ScrapSubmit">
       select s.*,u.name 'submit_name',
               u1.name 'first_acceptor_name',
               u2.name 'final_acceptor'
        from scrap_submit s inner join user u on s.submit_id = u.id
                                      left join user u1 on s.first_acceptor = u1.id
                                      left join user u2 on s.final_acceptor = u2.id

        where u.workcell_id = #{workcell_id} and (s.status = 1 or s.status = 2 or s.status = 0)
        limit #{page_number},5
    </select>
    <select id="supervisor_get_scrap_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from scrap_submit s
        inner join user u on s.submit_id = u.id
                                      left join user u1 on s.first_acceptor = u1.id
                                      left join user u2 on s.final_acceptor = u2.id
        where u.workcell_id = #{workcell_id} and (s.status = 1 or s.status = 2 or s.status = 0)
    </select>
    <update id="supervisor_pass_scrap_submit">
        update scrap_submit
        set status = '2', first_acceptor = #{user_id},first_time = now()
        where id = #{id}
    </update>
    <update id="supervisor_no_pass_scrap_submit">
        update scrap_submit
        set status = '1', first_acceptor = #{user_id},first_time = now(),first_reason = #{no_pass_reason}
        where id = #{id}
    </update>
    <select id="supervisor_get_scrap_submit_list_history" resultType="com.jig.entity.ScrapSubmit">
        select s.*,
        u1.name submit_name,
        u2.name first_acceptor_name,
        u3.name final_acceptor_name
        from scrap_submit_history s INNER JOIN user u1 on u1.id = s.submit_id
                                    LEFT JOIN user u2 on u2.id = s.first_acceptor
                                    LEFT JOIN user u3 on u3.id = s.final_acceptor
        <where>
            u1.workcell_id = #{workcell_id}
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        limit #{page_number},5
    </select>
    <select id="supervisor_get_scrap_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*)
        from scrap_submit_history s INNER JOIN user u1 on u1.id = s.submit_id
                                    LEFT JOIN user u2 on u2.id = s.first_acceptor
                                    LEFT JOIN user u3 on u3.id = s.final_acceptor
        <where>
            u1.workcell_id = #{workcell_id}
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
    </select>
</mapper>
