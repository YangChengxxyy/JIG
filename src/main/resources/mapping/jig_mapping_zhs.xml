<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jig.mapper.JigMapper_zhs">
    <insert id="addShoplist">
        insert into purchase_income_submit(submit_id,code,count,submit_time,status,production_line_id,bill_no)
        values (#{submit_id},#{code},#{count},#{submit_time},0,
        (select id from production_line where name = #{production_line_id}),
        #{bill_no})
    </insert>
    <select id="get_manager_purchase_submit_list" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,u.name submit_name,pl.name production_line_name from purchase_income_submit p inner join user u on p.submit_id = u.id
                                                                    inner join production_line pl on p.production_line_id = pl.id
        where p.status = 2
        limit #{page_number},5
    </select>
    <select id="get_manager_purchase_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit
        where status = 2
    </select>
    <select id="get_manager_purchase_detail" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select p.*,u.name submit_name from purchase_income_submit p inner join user u on p.submit_id = u.id
        where p.id = #{id}
    </select>
    <update id="manager_check_purchase_submit">
        update purchase_income_submit
        set final_time = now(),status = #{pass},final_acceptor='1230936'
        where id = #{id};

        insert into purchase_income_submit_history select * from purchase_income_submit where id = #{id};

        delete from purchase_income_submit where id = #{id}
    </update>
    <select id="get_manager_jig_info_list" resultType="com.jig.entity.JigDefinition">
        select *  from jig_definition j inner join jig_family f on j.family_id = f.id
        limit #{page_number},5
    </select>
    <select id="get_manager_jig_info_list_pages" resultType="java.lang.Integer">
        SELECT count(*) from jig_definition
    </select>
    <select id="get_manager_purchase_submit_list_history" resultType="com.jig.entity.PurchaseIncomeSubmit">
        select *,u.name submit_name,pl.name production_line_name from purchase_income_submit_history p inner join user u on p.submit_id = u.id
                                                                    inner join production_line pl on pl.id = p.production_line_id
        <where>
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        <if test="page_number!='-1'.toString()">
            limit #{page_number},5
        </if>

    </select>
    <select id="get_manager_purchase_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit_history p inner join user u on p.submit_id = u.id
        <where>
            <if test="bill_no!=''">
                and p.bill_no like concat('%',#{bill_no},'%')
            </if>
            <if test="submit_name!=''">
                and u.name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and p.status = #{status}
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(p.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
    </select>
    <select id="get_manager_purchase_submit_count" resultType="java.lang.Integer">
        select count(*) from purchase_income_submit
        where status = 2
    </select>
    <select id="get_manager_scrap_submit_count" resultType="java.lang.Integer">
        select count(*) from scrap_submit
    </select>
    <select id="get_manager_scrap_submit_list" resultType="com.jig.entity.ScrapSubmit">
        select s.*,u1.name submit_name,u2.name first_acceptor_name from scrap_submit s
        INNER JOIN user u1 on u1.id = s.submit_id
        INNER JOIN user u2 on u2.id = s.first_acceptor
    </select>
    <select id="get_manager_scrap_submit_list_pages" resultType="java.lang.Integer">
        select count(*) from scrap_submit
    </select>
    <update id="check_manager_scrap_submit">
        insert into scrap_submit_history select * from scrap_submit where id = #{submit_id};
        delete from scrap_submit where id = #{submit_id};
        update scrap_submit_history
        set status = #{status},final_time = now(),final_acceptor = '1230936'
        where id = #{submit_id}
    </update>
    <select id="get_manager_scrap_submit_list_history" resultType="com.jig.entity.ScrapSubmit">
        select s.*,u1.name submit_name,u2.name first_acceptor_name from scrap_submit_history s
        INNER JOIN user u1 on u1.id = s.submit_id
        INNER JOIN user u2 on u2.id = s.first_acceptor
        <where>
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
        limit #{page_number},5
    </select>
    <select id="get_manager_scrap_submit_list_history_pages" resultType="java.lang.Integer">
        select count(*) from scrap_submit_history s
        INNER JOIN user u1 on u1.id = s.submit_id
        INNER JOIN user u2 on u2.id = s.first_acceptor
        <where>
            <if test="code!=''">
                and s.code like concat('%',#{code},'%')
            </if>
            <if test="submit_name!=''">
                and s.submit_name like concat('%',#{submit_name},'%')
            </if>
            <if test="status!=''">
                and s.status = #{status}
            </if>
            <if test="scrap_reason!=''">
                and s.scrap_reason like concat('%',#{scrap_reason},'%')
            </if>
            <if test="start_date!='' and end_date !=''">
                and (STR_TO_DATE(s.submit_time,'%Y-%m-%d') BETWEEN '${start_date}' AND '${end_date}')
            </if>
        </where>
    </select>
    <select id="get_manager_store_jig_list" resultType="com.jig.entity.JigEntity">
        select *,count(code) as 'count' from jig_position group by code
    </select>
</mapper>
